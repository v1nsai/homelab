apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: jellyfin
  namespace: jellyfin
spec:
  project: default
  source:
    chart: jellyfin
    repoURL: https://github.com/v1nsai/jellyfin-helm
    targetRevision: master
    helm:
      releaseName: jellyfin
      valuesObject:
        persistence:
          config:
            enabled: true
            storageClass: microk8s-hostpath
          media:
            enabled: true
            existingClaim: the-goods
            accessMode: ReadWriteMany
        extraEnvVars:
          - name: NVIDIA_VISIBLE_DEVICES
            value: "all"
          - name: NVIDIA_DRIVER_CAPABILITIES
            value: "all"
          - name: DOTNET_SYSTEM_IO_DISABLEFILELOCKING
            value: "true"
        extraPodLabels:
          backup.velero.io/backup-volumes-excludes: "the-goods"
          velero.io/exclude-from-backup: "true"
        resources:
          limits:
            nvidia.com/gpu: "1"
        # nodeSelector:
        #   nvidia.com/gpu.present: "true"
  destination:
    name: in-cluster
    namespace: jellyfin
  syncPolicy:
    automated:
      prune: true
      selfHeal: true